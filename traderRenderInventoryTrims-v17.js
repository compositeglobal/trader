(function () {
    /* Configuration and QA */

    let params = new URLSearchParams(window.location.search);

    let lang;
    if (params.get('qa') === 'true' && params.get('lang')) {
        lang = params.get('lang');
    } else {
        lang = document.documentElement.lang;
    }

    let manufacturer;
    if (params.get('qa') === 'true' && params.get('manufacturer')) {
        manufacturer = params.get('manufacturer');
    } else {
        const metaTag = document.querySelector('meta[name="manufacturer"]');
        manufacturer = metaTag ? metaTag.getAttribute('content') : '';
    }

    let modelOverride;
    if (params.get('qa') === 'true' && params.get('model')) {
        modelOverride = params.get('model');
    } else {
        const metaTag = document.querySelector('meta[name="model"]');
        modelOverride = metaTag ? metaTag.getAttribute('content') : '';
    }

    if (params.get('qa') === 'true') {
        console.log('QA mode is activated - API requests are soruced from the "' + lang + '" language. The manufacturer has been set to "' + manufacturer + '".');
    }

    /* Inventory */

    document.addEventListener('DOMContentLoaded', () => {

        let cards = document.querySelectorAll('[data-at-card]');

        if (cards.length > 0) {

            const manufacturerMeta = manufacturer;
            const modelMeta = modelOverride;
            const modelMinYear = document.querySelector('meta[name="modelYear"]');
            let url = '';

            if (params.get('qa') === 'true' && lang === 'fr') {
                url = `https://apimqa.autohebdo.net/research/v1/vehicle-inventory?make=`;
            } else if (params.get('qa') === 'true') {
                url = `https://apimqa.autotrader.ca/research/v1/vehicle-inventory?make=`;
            } else if (lang === 'fr') {
                url = `https://apimktprd01.autohebdo.net/research/v1/vehicle-inventory?make=`;
            } else {
                url = `https://apimktprd01.autotrader.ca/research/v1/vehicle-inventory?make=`;
            }

            if (manufacturerMeta) {
                url += manufacturerMeta;
            }
            if (modelMeta) {
                url += '&model=' + modelMeta;
            }
            if (modelMinYear) {
                url += '&minYear=' + modelMinYear.getAttribute('content');
            }


            fetch(url, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {
                    document.body.removeAttribute('data-skeleton');

                    // If there are more cards than vehicles, remove the extra cards
                    if (cards.length > data.vehicles.length) {
                        for (let i = data.vehicles.length; i < cards.length; i++) {
                            cards[i].remove();
                        }
                    }

                    // Update href of all elements with 'data-at-inventory-url' attribute
                    const inventoryUrlElements = document.querySelectorAll('[data-at-inventory-url]');
                    inventoryUrlElements.forEach(element => {
                        element.href = data.searchUrl;
                    });

                    // Update the cards NodeList to reflect the removed cards
                    cards = document.querySelectorAll('[data-at-card]');

                    cards.forEach((card, index) => {
                        const vehicle = data.vehicles[index];
                        if (vehicle) {

                            card.setAttribute('data-an-position', index + 1);

                            for (let key in vehicle) {
                                if (typeof vehicle[key] === 'object' && vehicle[key] !== null) {
                                    // If the value is an object, add data attributes for each key in the object
                                    for (let subKey in vehicle[key]) {
                                        card.setAttribute(`data-an-${key}-${subKey}`, vehicle[key][subKey]);
                                    }
                                } else {
                                    card.setAttribute(`data-an-${key}`, vehicle[key]);
                                }
                            }

                            const textElements = card.querySelectorAll('[data-at-text]');
                            textElements.forEach(el => {
                                const key = el.getAttribute('data-at-text');
                                const keys = key.split('-');
                                let value = vehicle;
                                keys.forEach(k => {
                                    value = value[k];
                                });

                                if (key === 'price') {
                                    if (lang === 'fr') {

                                        value = new Intl.NumberFormat('fr-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);
                                    } else { 

                                        value = new Intl.NumberFormat('en-CA', { style: 'currency', currency: 'CAD', minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(value);                           
                                
                                    }

                                }



                                if (key === 'distance') {

                                    if (lang === 'fr') {

                                        value = `Ã€ ${value} km de vous`

                                    } else {
                                        value = `${value} km from you`;

                                    }

                                }

                                el.innerHTML = value;
                            });

                            const imageElements = card.querySelectorAll('[data-at-image]');
                            imageElements.forEach(el => {
                                const key = el.getAttribute('data-at-image');
                                const keys = key.split('-');
                                let value = vehicle;
                                keys.forEach(k => {
                                    value = value[k];
                                });
                                if (value) {
                                    el.src = value;
                                }
                            });

                            const linkElements = card.querySelectorAll('[data-at-link]');
                            linkElements.forEach(el => {
                                const key = el.getAttribute('data-at-link');
                                el.href = vehicle[key];
                            });
                        }
                    });

                }).then(() => {

                    // Apply data pushes to rendered inventory. 

                    let items = [];

                    let cards = document.querySelectorAll('[data-at-card]');

                    cards.forEach((parent, index) => {
                        let item = {
                            'item_id': '',
                            'item_name': '',
                            'listingPosition': 'organic',
                            'price': '',
                            'item_brand': '',
                            'item_category': 'not used',
                            'quantity': '1',
                            'ad_id': '',
                            'ad_make': '<MAKE>',
                            'ad_model': '<MODEL>',
                            'ad_province': '<PROVINCE>',
                            'ad_year': '<YEAR>',
                            'ad_dealer_id': '',
                            'raw_location': '',
                            'ad_position': 'organic',
                            'ad_active_upsells': 'organic',
                            'ad_upgrades_applied': 'not used',
                            'positions': ''
                        };

                        let itemMapping = {
                            'item_id': 'trackingid',
                            'item_name': 'model', // add brand and model
                            'item_brand': 'dealer-trackingid',
                            'ad_dealer_id': 'dealer-trackingid',
                            'price': 'price',
                            'quantity': '1',
                            'ad_id': 'trackingid',
                            'ad_make': 'make',
                            'ad_model': 'model',
                            'ad_province': 'province',
                            'ad_year': 'year',
                            'ad_position': 'ad-position',
                            'positions': 'position'

                        };

                        for (let key in item) {
                            let attrName = 'data-an-' + itemMapping[key];
                            let attr = parent.getAttribute(attrName);

                            if (attr !== null) {
                                if (key === 'item_name') {
                                    var metaContent = document.querySelector('meta[name="manufacturer"]').content;
                                    item[key] = metaContent + ' | ' + attr;
                                } else {
                                    item[key] = attr;
                                }
                            }
                        }

                        items.push(item);
                    });

                    let vehicle = [];

                    cards.forEach((parent) => {
                        let item = {
                            'adID': '<AD ID>',
                            'upgradesApplied': 'not used',
                            'dealerID': 'trackingid',
                            'listingPosition': 'organic',
                            'make': '<MAKE>',
                            'model': '<MODEL>',
                            'price': '<PRICE>',
                            'province': '<PROVINCE>',
                            'rawLocation': '',
                            'year': '<YEAR>'
                        };

                        let itemMapping = {
                            'adID': 'trackingid',
                            'dealerID': 'dealer-trackingid',
                            'make': 'make',
                            'model': 'model',
                            'price': 'price',
                            'province': 'province',
                            'year': 'year'
                        };

                        for (let key in item) {
                            let attrName = 'data-an-' + itemMapping[key];
                            let attr = parent.getAttribute(attrName);

                            if (attr !== null) {
                                if (key === 'item_name') {
                                    var metaContent = document.querySelector('meta[name="manufacturer"]').content;
                                    item[key] = metaContent + ' | ' + attr;
                                } else {
                                    item[key] = attr;
                                }
                            }
                        }

                        vehicle.push(item);
                    });

                    function generateDataPush(items, type, vehicle) {
                        let elementTitle = document.querySelector('[data-push-title]');

                        let dataPush = {
                            'event': type,
                            'listKey': elementTitle.textContent.replace(/\n/g, ' ').trim(),
                            'ecommerce': { 'item_list_name': 'storefront - ' + elementTitle.textContent.replace(/\n/g, ' ').trim(), items }
                        };

                        if (vehicle != null) {
                            dataPush['vehicle'] = vehicle;
                        }

                        return dataPush;
                    }

                    let dataPush = generateDataPush(items, 'view_item_list');

                    dataLayer.push(dataPush);

                    function handleClick(event) {
                        let link = event.target.closest('a');
                        let parentElement = link.parentNode;
                        let index = Array.from(parentElement.parentNode.children).indexOf(parentElement);

                        let dataPush = generateDataPush([items[index]], 'select_item', vehicle[index]);

                        dataLayer.push(dataPush);
                    }

                    cards.forEach((card) => {
                        card.addEventListener('click', handleClick);
                    });

                });

        }

    });

    /* Trims Translations */

    const mapping =
    {
        "360 Camera": "CamÃ©ra Ã  360Â°",
        "Adaptive Cruise Control": "RÃ©gulateur de vitesse adaptatif",
        "Add Vehicle": "Ajouter vÃ©hicule",
        "Air Conditioning": "Climatiseur",
        "All Features": "Toutes les caractÃ©ristiques",
        "AM/FM Stereo": "AM/FM StÃ©rÃ©o",
        "Android Auto": "Android Auto",
        "Apple CarPlay": "Apple CarPlay",
        "Auto-Dimming Rearview Mirror": "RÃ©troviseur Ã  attÃ©nuation automatique",
        "Automatic Headlights": "Phares automatiques",
        "Automatic Parking": "Stationnement automatique",
        "AutoTrader Review": "Avis AutoHebdo",
        "Auxiliary Audio Input": "Prise audio auxiliaire",
        "Back-Up Camera": "CamÃ©ra de recul",
        "Base Curb Weight": "Poids Ã  vide ",
        "Based on": "Selon",
        "Battery Range": "PortÃ©e batterie (km)",
        "Bed Liner": "Doublure de caisse",
        "Blind Spot Monitor": "Surveillance de lâ€™angle mort",
        "Bluetooth Connection": "Interface Bluetooth",
        "Brake": "Freins",
        "Brake ABS System": "Freinage ABS",
        "Brake Assist": "Freinage assistÃ©",
        "Buyerâ€™s Guide": "Guide dâ€™achat",
        "Canadian MSRP": "PDSF",
        "MSRP": "PDSF",
        "Canopy": "Toit amovible",
        "Car Comparison": "Comparatif de vÃ©hicules",
        "Cargo Volume ": "Volume cargo ",
        "Cargo Volume to First Row": "Volume cargo 1re rangÃ©e ",
        "Cargo Volume to Second Row": "Volume cargo 2e rangÃ©e ",
        "Cargo Volume to Third Row": "Volume cargo 3e rangÃ©e ",
        "CD Player": "Lecteur CD",
        "Change Vehicle": "Changer vÃ©hicule",
        "Child Safety Locks": "Verrous de sÃ©curitÃ© pour enfants",
        "Climate Control": "Climatisation automatique",
        "Comfort": "Confort",
        "Compare": "Comparer",
        "Compare Cars Side by Side": "Comparatif de modÃ¨les cÃ´te Ã  cÃ´te",
        "Compare Trims": "Comparer les versions",
        "Want to see which vehicle is better? Use our Vehicle Comparison Tool and see their price, specs and features side by side.": "Vous nâ€™avez pas encore trouvÃ© le modÃ¨le qui vous convient le mieux? Utilisez notre outil comparatif pour afficher les prix, donnÃ©es techniques et autres caractÃ©ristiques en cÃ´te Ã  cÃ´te.",
        "Comparison": "Comparaison",
        "Compare prices, trims, specs, options, features and scores of up to five cars, trucks or SUVs that are available in Canada with our free side-by-side car comparison tool.": "Compare les prix, versions, donnÃ©es techniques, options, caractÃ©ristiques et cotes dâ€™un maximum de cinq voitures, camions ou VUS offerts au Canada avec notre outil gratuit de comparaison en face Ã  face.",
        "Connectivity": "ConnectivitÃ©",
        "Convenience": "CommoditÃ©",
        "Cooled Front Seat(s)": "SiÃ¨ges avant ventilÃ©s",
        "Cooled Rear Seat(s)": "SiÃ¨ges arriÃ¨re ventilÃ©s",
        "Cross-Traffic Alert": "Alerte de circulation transversale",
        "Cruise Control": "RÃ©gulateur de vitesse",
        "Data provided by": "DonnÃ©es fournies par",
        "Daytime Running Lights": "Feux de jour",
        "Dead Weight Hitch - Max Tongue Wt.": "Cap. de remorquage, attelage - Poids max. au timon",
        "Dead Weight Hitch - Max Trailer Wt.": "Cap. de remorquage, attelage - Charge utile max.",
        "Differences": "DiffÃ©rences",
        "Displacement": "CylindrÃ©e",
        "DriverAssistance": "Aide Ã  la conduite",
        "Driver Assistance": "Aide Ã  la conduite",
        "Driver Adjustable Lumbar": "Ajustement lombaire conducteur",
        "Driver Air Bag": "Coussin gonflable conducteur",
        "Driver Restriction Features": "Restrictions de conduite",
        "Drivetrain": "EntraÃ®nement",
        "Emergency Trunk Release": "Ouverture dâ€™urgence du coffre",
        "Engine": "Moteur",
        "Engine Immobilizer": "AntidÃ©marreur",
        "Explore": "AnnÃ©es-modÃ¨les",
        "Exterior": "ExtÃ©rieur",
        "Exterior Styling": "Style extÃ©rieur",
        "Fifth Wheel Hitch - Max Tongue Wt.": "Attelage Ã  sellette - Poids max. au timon",
        "Fifth Wheel Hitch - Max Trailer Wt.": "Attelage Ã  sellette - Charge utile max.",
        "for Sale": "Ã  vendre",
        "Front Head Air Bag": "Coussin gonflable avant",
        "Front Head Room": "DÃ©gagement tÃªte, avant ",
        "Front Leg Room": "DÃ©gagement genoux, avant ",
        "Front Reading Lamps": "Lampes de lecture avant",
        "Front Shoulder Room": "DÃ©gagement Ã©paules, avant ",
        "Front Side Air Bag": "Coussins gonflables latÃ©raux avant",
        "Front Tire Size": "Pneus avant",
        "Fuel": "Carburant",
        "Fuel Capacity": "Cap. carburant (L)",
        "Fuel Consumption: City": "Consom. carburant: Ville",
        "Fuel Consumption: City/HWY Combined": "Consom. carburant: CombinÃ©",
        "Fuel Consumption: Equivalent - City": "Consom. carburant: Ã‰quivalent - Ville",
        "Fuel Consumption: Equivalent - City/HWY Combined": "Consom. carburant: Ã‰quivalent - CombinÃ©",
        "Fuel Consumption: Equivalent - Highway": "Consom. carburant: Ã‰quivalent - Autoroute",
        "Fuel Consumption: Highway": "Consom. carburant: Autoroute",
        "Fuel Economy": "Ã‰conomie de carburant",
        "Fuel System": "SystÃ¨me dâ€™alimentation",
        "Hands-Free Liftgate": "Hayon motorisÃ© main libre",
        "Hard Disk Drive Media Storage": "Disque dur stockage mÃ©dia",
        "HD Radio": "Radio HD",
        "Headlights-Auto-Leveling": "Phares Ã  nivellement automatique",
        "Heads-Up Display": "Affichage tÃªte haute",
        "Head to Head Comparisons": "Comparatif face-Ã -face",
        "Heated Front Seat(s)": "SiÃ¨ges avant chauffants",
        "Heated Mirrors": "Miroirs chauffants",
        "Heated Rear Seat(s)": "SiÃ¨ges arriÃ¨re chauffants",
        "Heated Steering Wheel": "Volant chauffant",
        "Height, Overall": "Hauteur hors-tout ",
        "HID headlights": "Phares HID",
        "Horsepower": "Puissance",
        "Infotainment": "Infodivertissement",
        "Integrated Turn Signal Mirrors": "Miroirs Ã  feux clignotants intÃ©grÃ©s",
        "Interior": "IntÃ©rieur",
        "Interior Design": "CommoditÃ© intÃ©rieure",
        "Inventory": "Inventaire",
        "Keyless Entry": "TÃ©lÃ©dÃ©verrouillage",
        "Keyless Start": "DÃ©marrage sans clÃ©",
        "Key Specifications for": "Principales caractÃ©ristiques:",
        "Knee Air Bag": "Coussin gonflable aux genoux",
        "Lane Departure Warning": "Avertisseur de dÃ©rive",
        "Lane Keeping Assist": "Aide au maintien dans la voie",
        "Latest Automotive Articles": "Plus rÃ©cents articles automobiles",
        "Latest Convertibles": "Plus rÃ©centes dÃ©capotables",
        "Latest Coupes": "CoupÃ©s neufs",
        "Latest Hatchbacks": "VÃ©hicules Ã  hayon",
        "Latest Minivans": "Minifourgonnettes neuves",
        "Latest Sedans": "Berlines neuves",
        "Latest SUVs": "VUS neufs",
        "Latest Trucks": "Camions neufs",
        "Latest and Upcoming Vehicles": "VÃ©hicules rÃ©cents et non dÃ©voilÃ©s",
        "Latest Vehicles": "Plus rÃ©cents vÃ©hicules",
        "Latest Wagons": "Familiales neuves",
        "Length, Overall": "Longueur hors-tout ",
        "Less Makes": "Moins de marques",
        "Lighting": "Ã‰clairage",
        "Luggage Rack": "Porte-bagages",
        "Make": "Marque",
        "Manufacturer Recall Number": "NumÃ©ro de rappel du fabricant",
        "Maximum Trailering Capacity": "CapacitÃ© de remorque max.",
        "Mechanical": "MÃ©canique",
        "Min Ground Clearance": "Garde au sol ",
        "Mirror Memory": "Miroir Ã  mÃ©moire",
        "Model": "ModÃ¨le",
        "Model year(s) affected": "AnnÃ©e-modÃ¨le touchÃ©e",
        "Model Overview": "AperÃ§u du modÃ¨le",
        "Models": "ModÃ¨les",
        "More Makes": "Plus de marques",
        "Most Popular Comparisons": "Plus populaires comparatifs",
        "MP3 Player": "Lecteur MP3",
        "Multi-Zone Air Conditioning": "Climatiseur multizone",
        "N/A": "s.o.",
        "Navigation System": "SystÃ¨me de navigation",
        "News and Reviews": "Nouvelles et Revues",
        "Frequently Asked Questions About the": "Foire Aux Questions Sur la",
        "Night Vision": "SystÃ¨me de vision nocturne",
        "No content available": "Aucun contenu disponible",
        "No deals currently available for this location.": "PrÃ©sentement aucune offre pour cet emplacement.",
        "There is no record of recalls for the": "Aucun rappel trouvÃ© pour",
        "Not Available": "Non offert",
        "Notification Type": "Type de notification",
        "Optional": "En option",
        "Overall Score": "Note globale",
        "Owner Reviews": "Ã‰valuations de propriÃ©taires",
        "Owner Scores": "Avis des proprios",
        "Passenger Adjustable Lumbar": "Ajustement lombaire passager",
        "Passenger Air Bag": "Coussin gonflable passager",
        "Passenger Capacity": "Nb. de passagers",
        "Pickup Bed Tonneau Cover": "Couvercle de caisse rigide",
        "Power Door Locks": "Verrouillage Ã©lectrique",
        "Power Driver Seat": "SiÃ¨ge motorisÃ© conducteur",
        "Power Folding Mirrors": "Miroirs escamotables",
        "Power Liftgate": "Hayon motorisÃ©",
        "Power Mirror(s)": "Miroirs Ã©lectriques",
        "Power Outlet": "Prise de courant",
        "Power Passenger Seat": "SiÃ¨ge motorisÃ© passager",
        "Power Retractable Running Boards": "Marchepieds motorisÃ©s rÃ©tractables",
        "Power Windows": "Vitres Ã©lectriques",
        "Cars": "Automobiles",
        "Compare Vehicles": "Comparer vÃ©hicules",
        "Convertibles": "DÃ©capotables",
        "Coupes": "CoupÃ©s",
        "Hatchbacks": "VÃ©hicules Ã  hayon",
        "Already have a model in mind? Dive in and see information on trims, prices, specs, options and more!": "Vous avez dÃ©jÃ  un modÃ¨le en tÃªte? SÃ©lectionnez-le ci-dessous pour dÃ©couvrir les versions, prix, donnÃ©es techniques, options et plus!",
        "Home": "Accueil",
        "Luxury Sedans": "Berlines de luxe",
        "Luxury SUVs": "VUS de luxe",
        "Minivans": "Minifourgonnettes",
        "Sedans": "Berlines",
        "SUVs": "VUS",
        "Trucks": "Camions",
        "Wagons": "Familiales",
        "Rain Sensing Wipers": "Essuie-glace automatiques",
        "Read less": "Lire moins",
        "Read more": "Lire plus",
        "Rear Air Conditioning": "Climatisation Ã  lâ€™arriÃ¨re",
        "Rear Head Air Bag": "Coussin gonflable arriÃ¨re",
        "Rear Head Room": "DÃ©gagement tÃªte, arriÃ¨re ",
        "Rear Leg Room": "DÃ©gagement genoux, arriÃ¨re ",
        "Rear Parking Aid": "Aide au stationnement arriÃ¨re",
        "Rear Reading Lamps": "Lampes de lecture arriÃ¨re",
        "Rear Seat Audio Controls": "Commandes audio aux siÃ¨ges arriÃ¨re",
        "Rear Shoulder Room": "DÃ©gagement Ã©paules, arriÃ¨re ",
        "Rear Side Air Bag": "Coussins gonflables latÃ©raux arriÃ¨re",
        "Rear Tire Size": "Pneus arriÃ¨re",
        "Recall date": "Date de rappel",
        "Recall Information": "Rappels",
        "Recall number": "NÂ° de rappel",
        "Reliability": "FiabilitÃ©",
        "Remote Engine Start": "DÃ©marreur Ã  distance",
        "Remote Trunk Release": "Couvercle de coffre tÃ©lÃ©commandÃ©",
        "Research": "Rechercher",
        "Research By Make": "Recherche par marque",
        "reviews": "avis",
        "Reviews & News": "Revues et nouvelles",
        "Rollover Protection Bars": "Barres de protection antiroulis",
        "Roof": "Toit",
        "Running Boards/Side Steps": "Marchepieds",
        "Safety": "SÃ©curitÃ©",
        "Satellite Radio": "Radio satellite",
        "Search now": "Rechercher maintenant",
        "Seat-Massage": "SiÃ¨ges Ã  massage",
        "Seatbelt Air Bag": "Coussin gonflable de ceinture",
        "Seat Memory": "MÃ©moire de siÃ¨ge",
        "Seats": "SiÃ¨ges",
        "Security": "SÃ©curitÃ©",
        "Security System": "SystÃ¨me de sÃ©curitÃ©",
        "Select Another Vehicle": "SÃ©lectionner autre vÃ©hicule",
        "Select A Vehicle": "SÃ©lectionner un vÃ©hicule",
        "Similar Vehicles": "VÃ©hicules similaires",
        "Smart Device Integration": "IntÃ©gration appareils intelligents",
        "Stability Control": "ContrÃ´le de stabilitÃ©",
        "Standard": "De sÃ©rie",
        "Steering": "Direction",
        "Steering Wheel-Audio Controls": "Commandes de la radio au volant",
        "Stepside Pickup Box": "Caisse stepside",
        "Sun/Moon Roof": "Toit soleil/lune",
        "System affected": "SystÃ¨me touchÃ©",
        "Third Row Head Room": "DÃ©gagement tÃªte, 3e rangÃ©e ",
        "Third Row Leg Room": "DÃ©gagement genoux, 3e rangÃ©e ",
        "Third Row Shoulder Room": "DÃ©gagement Ã©paules, 3e rangÃ©e ",
        "Tire Pressure Monitor": "Surv. pression des pneus",
        "Torque": "Couple",
        "Traction Control": "SystÃ¨me antipatinage",
        "Trader Scores": "Cotes AutoHebdo",
        "Transmission": "Transmission",
        "Transport Canada": "Transports Canada",
        "Trim Comparison": "Comparatif de versions",
        "Trim (Optional)": "Version (En option)",
        "Trunk Volume": "Volume coffre",
        "Units Affected": "UnitÃ©s affectÃ©es",
        "Universal Garage Door Opener": "Ouvre-porte de garage universel",
        "Upcoming": "Ã€ venir",
        "Variable Speed Intermittent Wipers": "Essuie-glaces intermittents",
        "Vehicle Information": "Renseignements sur le vÃ©hicule",
        "This vehicle has not yet been reviewed": "Soyez le premier Ã  donner votre avis!",
        "Vehicle Research": "Rechercher vÃ©hicule",
        "View all": "Voir toutes les",
        "View All Articles": "Tous les articles",
        "View all owner reviews": "Voir tous les avis de propriÃ©taires",
        "View Deals": "Voir les offres",
        "View details": "Afficher dÃ©tails",
        "View Inventory": "Voir inventaire",
        "View Issue": "Voir le problÃ¨me",
        "View less recalls": "Afficher moins de rappels",
        "View more recalls": "Voir plus de rappels",
        "Wheelbase": "Empattement",
        "Wheels-Locks": "Ã‰crous de roues de sÃ©curitÃ©",
        "Width, Max w/o mirrors": "Largeur, sans rÃ©troviseurs ",
        "WiFi Hotspot": "Point dâ€™accÃ¨s Wi-Fi",
        "Wireless Charging": "Recharge sans fil",
        "Wt Distributing Hitch - Max Tongue Wt.": "Attelage Ã  redistribution - Poids max. au timon",
        "Wt Distributing Hitch - Max Trailer Wt.": "Attelage Ã  redistribution - Charge utile max.",
        "Year": "AnnÃ©e",
        "Showing {0} of {1} trims": "{0} de {1} versions",
        "News": "Nouvelles",
        "Review": "Revue",
        "No model overview available": "Aucun aperÃ§u du modÃ¨le disponible",
        "Cargo Volume with Rear Seat Down": "Volume cargo, siÃ¨ges arriÃ¨re abaissÃ©s",
        "Cargo Volume with Rear Seat Up": "Volume cargo, siÃ¨ges arriÃ¨re levÃ©s",
        "Reviews and News": "Revues et nouvelles",
        "No": "Non",
        "Yes": "Oui",
        "4Â WheelÂ Disc": "Disque aux 4 roues",
        "4Â WheelÂ Drum": "Tambour aux 4 roues",
        "All-wheel": "4RM",
        "Flex Fuel": "Flex Fuel",
        "for": "pour",
        "Front-wheel": "Roues avant",
        "FrontÂ DiscÂ RearÂ Drum": "Disques avant/tambours arr.",
        "Gasoline": "Essence",
        "Gasoline direct injection": "Injection directe d'essence",
        "Hydrogen": "HydrogÃ¨ne",
        "I-6 twin turbo premium unleaded": "I-6 double turbo super sans plomb",
        "ManualÂ Steering": "Direction non assistÃ©e",
        "There are no reviews and news": "Aucun avis / nouvelle",
        "Port/direct injection": "Injection indirecte/directe",
        "PowerÂ Steering": "Direction assistÃ©e",
        "V-6 twin turbo regular unleaded": "V-6 double turbo rÃ©gulier sans plomb",
        "V-8 regular unleaded": "V-8 rÃ©gulier sans plomb",
        "Wheel drive": "EntraÃ®nement",
        "Compare {0}": "Comparer {0}",
        "DRIVABILITY": "AGRÃ‰MENT CONDUITE",
        "FEATURES": "CARACTÃ‰RISTIQUES",
        "POWERTRAIN": "GROUPE MOTOPROPULSEUR",
        "PRACTICALITY": "COMMODITÃ‰",
        "QUALITY": "SÃ‰CURITÃ‰",
        "STYLING": "STYLISME",
        "USABILITY/ERGONOMICS": "UTILISATION/ERGONOMIE",
        "VALUE": "VALEUR",
        "Owner Score": "Avis des proprios",
        "Deals": "offres",
        "in": "Ã ",
        "Review & Compare: <br /> {0} Trims": "Examiner et comparer : <br /> {0} finitions",
        "Review: {0} Trim": "Examiner : {0} finition",
        "The {0} has <strong>{1} trims.</strong> Below you will be able to review all the trims with the option to compare.": "La {0} comporte <strong>{1} finitions.</strong> Ci-dessous, vous pourrez passer en revue toutes les versions avec la possibilitÃ© de les comparer.",
        "The {0} has <strong>1 trim.</strong> Below you will be able to review this trim in detail.": "Le {0} a <strong>1 garniture.</strong> Vous pourrez examiner cette garniture en dÃ©tail ci-dessous.",
        "trims available": "finitions disponibles",
        "trim available": "finition disponibles",
        "Filter by trim level": "Filtrer par niveau de garniture intÃ©rieure",
        "Apply": "Appliquer",
        "Clear all": "Effacer",
        "of": "de",
        "Add to comparison": "Ajouter Ã  la comparaison",
        "Show full trim specifications": "Afficher toutes les caractÃ©ristiques des finitions",
        "Starting at": "Ã€ partir de"
    }

    /* Trims */

    document.addEventListener('DOMContentLoaded', () => {

        const dataTrimsElements = document.querySelectorAll('[data-trims]');

        if (dataTrimsElements.length > 0) {

            const make = manufacturer;
            const model = modelOverride;
            const yearMeta = document.querySelector('meta[name="year"]');
            const year = yearMeta && yearMeta.content ? yearMeta.content : "2023";

            let url = '';

            if (params.get('qa') === 'true' && lang === 'fr') {
                url = `https://apimqa.autohebdo.net/research/v1/trims-information?make=${make}&model=${model}&year=${year}`;
            } else if (params.get('qa') === 'true') {
                url = `https://apimqa.autotrader.ca/research/v1/trims-information?make=${make}&model=${model}&year=${year}`;
            } else if (lang === 'fr') {
                url = `https://apimktprd01.autohebdo.net/research/v1/trims-information?make=${make}&model=${model}&year=${year}`;
            } else {
                url = `https://apimktprd01.autotrader.ca/research/v1/trims-information?make=${make}&model=${model}&year=${year}`;
            }

            fetch(url, { credentials: 'include' })
                .then(response => response.json())
                .then(data => {

                    dataTrimsElements.forEach(dataTrims => {

                        const clone = dataTrims.firstElementChild.cloneNode(true);

                        dataTrims.innerHTML = '';

                        data.forEach((item, index) => {
                            const itemClone = clone.cloneNode(true);

                            dataTrims.appendChild(itemClone);
                            // Update the slides
                            swiperTrims.updateSlides();

                            itemClone.setAttribute('data-gtm-content-name', 'Slide ' + (index + 1) + ' - ' + item['name']);

                            let gtmModel = itemClone.querySelector('[data-gtm-content-model]');
                            if (gtmModel) {
                                gtmModel.setAttribute('data-gtm-content-model', item['name']);
                            }

                            itemClone.querySelectorAll('[data-trim-text]').forEach(el => {
                                const keys = el.getAttribute('data-trim-text').split('-');
                                let value = item;
                                keys.forEach(key => {
                                    value = value[key];
                                });

                                el.innerHTML = value;
                            });

                            itemClone.querySelectorAll('[data-trim-image]').forEach(el => {
                                const keys = el.getAttribute('data-trim-image').split('-');
                                let value = item;
                                keys.forEach(key => {
                                    value = value[key];
                                });

                                if (value) {
                                    el.src = value;
                                }
                            });

                            let trimCount = itemClone.querySelectorAll('[data-trim-count]');
                            if (trimCount.length > 0) {
                                trimCount.forEach(el => {
                                    const countType = el.getAttribute('data-trim-count');
                                    if (countType === 'current') {
                                        el.innerHTML = index + 1;
                                    } else if (countType === 'total') {
                                        el.innerHTML = data.length;
                                    }
                                });
                            }

                            const keySpecsEl = itemClone.querySelector('[data-trim-key-specifications]');
                            if (keySpecsEl) {
                                const keySpecClone = keySpecsEl.firstElementChild.cloneNode(true);

                                keySpecsEl.innerHTML = '';

                                item.keySpecifications.forEach(spec => {
                                    const newKeySpecClone = keySpecClone.cloneNode(true);
                                    newKeySpecClone.innerHTML = spec;
                                    keySpecsEl.appendChild(newKeySpecClone);
                                });
                            }

                            const specsEl = itemClone.querySelector('[data-trims-specs]');
                            if (specsEl) {
                                const specClone = specsEl.children[1].cloneNode(true);
                                specsEl.removeChild(specsEl.children[1]);
                                Object.entries(item.categories).forEach(([key, value]) => {
                                    const newSpecClone = specClone.cloneNode(true);


                                    if (lang === 'fr') {

                                        newSpecClone.querySelector('[data-trims-specs=title]').innerHTML = mapping[key];

                                    } else {

                                        newSpecClone.querySelector('[data-trims-specs=title]').innerHTML = key;
                                    }

                                    newSpecClone.querySelector('[mirror-click]').setAttribute('mirror-click', key);

                                    const listEl = newSpecClone.querySelector('[data-trims-spec=list]');
                                    const listItemClone = listEl.firstElementChild.cloneNode(true);

                                    listEl.innerHTML = '';
                                    Object.entries(value).forEach(([specKey, specValue]) => {
                                        const newListItemClone = listItemClone.cloneNode(true);

                                        if (lang === 'fr') {

                                            newListItemClone.querySelector('[data-trims-spec=key]').innerHTML = mapping[specKey];

                                        } else {

                                            newListItemClone.querySelector('[data-trims-spec=key]').innerHTML = specKey;
                                        }

                                        if (specValue.toLowerCase() === 'yes') {
                                            newListItemClone.querySelector('[data-trims-spec=value]').innerHTML = lang === 'fr' ? 'Inclus' : 'Included';                                            
                                            newListItemClone.querySelector('[data-trims-spec=value]').className += ' trim_table_included';
                                        } else if (specValue.toLowerCase() === 'no') {
                                            newListItemClone.querySelector('[data-trims-spec=value]').innerHTML = lang === 'fr' ? 'Inclus' : 'Non Inclus';                                            
                                            newListItemClone.querySelector('[data-trims-spec=value]').className += ' trim_table_not-available';
                                        } else {
                                            newListItemClone.querySelector('[data-trims-spec=value]').innerHTML = specValue;
                                        }

                                        listEl.appendChild(newListItemClone);
                                    });

                                    specsEl.appendChild(newSpecClone);
                                });
                            }

                        });

                        const totalEls = document.querySelectorAll('[data-trim-total]');

                        totalEls.forEach(totalEl => {
                            if (totalEl) {

                                if (lang === 'fr') {

                                    totalEl.innerHTML = `${data.length} ${data.length === 1 ? 'version' : 'versions'}`;

                                } else {

                                    totalEl.innerHTML = `${data.length} ${data.length === 1 ? 'trim' : 'trims'}`;

                                }

                            }
                        });
                        window.Webflow && window.Webflow.destroy();
                        window.Webflow && window.Webflow.ready();
                        window.Webflow && window.Webflow.require('ix2').init();
                        document.dispatchEvent(new Event('readystatechange'));

                        // Mirror Clicks

                        const mirrorElements = document.querySelectorAll('[mirror-click]');

                        mirrorElements.forEach(element => {
                            element.addEventListener('click', function (event) {
                                // Only proceed if this is a user-initiated event
                                if (!event.isTrusted) {
                                    return;
                                }

                                const mirrorValue = this.getAttribute('mirror-click');

                                const sameMirrorElements = document.querySelectorAll(`[mirror-click="${mirrorValue}"]`);

                                sameMirrorElements.forEach(el => {
                                    if (el !== this) { // Avoid infinite loop by not clicking the element that was originally clicked
                                        el.click();
                                    }
                                });
                            });
                        });

                    });
                });

        }
    });

})();
